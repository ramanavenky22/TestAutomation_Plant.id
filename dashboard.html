<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Plant.id Test Automation Dashboard</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 20px;
            min-height: 100vh;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            text-align: center;
        }

        .header h1 {
            color: #333;
            margin-bottom: 10px;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        .stat-card h3 {
            color: #666;
            font-size: 14px;
            text-transform: uppercase;
            margin-bottom: 10px;
        }

        .stat-card .value {
            font-size: 36px;
            font-weight: bold;
            color: #667eea;
        }

        .stat-card.pass .value {
            color: #10b981;
        }

        .stat-card.fail .value {
            color: #ef4444;
        }

        .stat-card.accuracy .value {
            color: #f59e0b;
        }

        .test-results {
            background: white;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }

        .test-results h2 {
            color: #333;
            margin-bottom: 20px;
        }

        .test-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
            gap: 20px;
        }

        .test-card {
            border: 2px solid #e5e7eb;
            border-radius: 10px;
            padding: 20px;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .test-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 12px rgba(0, 0, 0, 0.15);
        }

        .test-card.pass {
            border-color: #10b981;
            background: #f0fdf4;
        }

        .test-card.fail {
            border-color: #ef4444;
            background: #fef2f2;
        }

        .test-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 15px;
        }

        .test-id {
            font-weight: bold;
            color: #333;
            font-size: 18px;
        }

        .status-badge {
            padding: 5px 15px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: bold;
            text-transform: uppercase;
        }

        .status-badge.pass {
            background: #10b981;
            color: white;
        }

        .status-badge.fail {
            background: #ef4444;
            color: white;
        }

        .test-image {
            width: 100%;
            height: 200px;
            object-fit: cover;
            border-radius: 8px;
            margin-bottom: 15px;
            border: 2px solid #e5e7eb;
        }

        .test-details {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-bottom: 15px;
        }

        .detail-item {
            padding: 10px;
            background: #f9fafb;
            border-radius: 5px;
        }

        .detail-label {
            font-size: 12px;
            color: #666;
            text-transform: uppercase;
            margin-bottom: 5px;
        }

        .detail-value {
            font-size: 14px;
            font-weight: bold;
            color: #333;
        }

        .detail-value.expected {
            color: #3b82f6;
        }

        .detail-value.predicted {
            color: #8b5cf6;
        }

        .confidence-bar {
            width: 100%;
            height: 8px;
            background: #e5e7eb;
            border-radius: 4px;
            overflow: hidden;
            margin-top: 5px;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #10b981, #3b82f6);
            transition: width 0.3s;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #666;
        }

        .error {
            background: #fef2f2;
            border: 2px solid #ef4444;
            color: #991b1b;
            padding: 20px;
            border-radius: 10px;
            margin: 20px 0;
        }

        .file-input-container {
            margin-bottom: 20px;
        }

        .file-input-label {
            display: inline-block;
            padding: 10px 20px;
            background: #667eea;
            color: white;
            border-radius: 5px;
            cursor: pointer;
            transition: background 0.2s;
        }

        .file-input-label:hover {
            background: #5568d3;
        }

        button.file-input-label {
            cursor: pointer;
            border: none;
            font-size: 14px;
        }

        button.file-input-label:hover {
            opacity: 0.9;
        }

        input[type="file"] {
            display: none;
        }

        #emptyState {
            background: white;
            padding: 40px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            text-align: center;
        }

        #emptyState code {
            background: #f3f4f6;
            padding: 2px 6px;
            border-radius: 3px;
            font-family: 'Courier New', monospace;
            color: #667eea;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üå± Plant.id Test Automation Dashboard</h1>
            <p>Test Results Visualization and Statistics</p>
        </div>

        <div class="file-input-container" style="display: flex; gap: 10px; align-items: center; justify-content: center;">
            <button id="refreshBtn" class="file-input-label" style="background: #10b981;">üîÑ Refresh Results</button>
        </div>

        <div id="emptyState" class="loading" style="display: block;">
            <p>üìä No test results found. Run the test automation script to generate results.</p>
            <p style="font-size: 14px; color: #666; margin-top: 10px;">The dashboard will automatically load <code>plant_ai_test_results.csv</code> when available.</p>
        </div>

        <div id="statsContainer" class="stats-container" style="display: none;">
            <div class="stat-card">
                <h3>Total Tests</h3>
                <div class="value" id="totalTests">0</div>
            </div>
            <div class="stat-card pass">
                <h3>Passed</h3>
                <div class="value" id="passedTests">0</div>
            </div>
            <div class="stat-card fail">
                <h3>Failed</h3>
                <div class="value" id="failedTests">0</div>
            </div>
            <div class="stat-card accuracy">
                <h3>Accuracy</h3>
                <div class="value" id="accuracy">0%</div>
            </div>
            <div class="stat-card">
                <h3>Avg Confidence</h3>
                <div class="value" id="avgConfidence">0%</div>
            </div>
        </div>

        <div id="testResults" class="test-results" style="display: none;">
            <h2>Test Results</h2>
            <div id="testGrid" class="test-grid"></div>
        </div>

        <div id="loading" class="loading" style="display: none;">
            <p>Loading test results...</p>
        </div>

        <div id="error" class="error" style="display: none;"></div>
    </div>

    <script>
        let testData = [];
        const CSV_FILE = 'plant_ai_test_results.csv';

        // Refresh button handler
        document.getElementById('refreshBtn').addEventListener('click', function() {
            loadDefaultCSV();
        });

        // Auto-load the CSV file on page load
        window.addEventListener('load', function() {
            loadDefaultCSV();
        });

        // Function to load the default CSV file
        function loadDefaultCSV() {
            document.getElementById('loading').style.display = 'block';
            document.getElementById('error').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';
            document.getElementById('statsContainer').style.display = 'none';
            document.getElementById('testResults').style.display = 'none';

            fetch(CSV_FILE + '?t=' + new Date().getTime())
                .then(response => {
                    if (response.ok) {
                        return response.text();
                    }
                    if (response.status === 404) {
                        throw new Error('CSV file not found');
                    }
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                })
                .then(text => {
                    if (!text || text.trim().length === 0) {
                        throw new Error('CSV file is empty');
                    }
                    document.getElementById('loading').style.display = 'none';
                    parseCSV(text);
                })
                .catch(err => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('emptyState').style.display = 'block';
                    console.log('Auto-load failed:', err.message);
                });
        }

        function loadCSV(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                parseCSV(e.target.result);
            };
            reader.readAsText(file);
        }

        function parseCSV(csvText) {
            document.getElementById('error').style.display = 'none';
            document.getElementById('emptyState').style.display = 'none';

            try {
                const lines = csvText.split('\n').filter(line => line.trim());
                if (lines.length < 2) {
                    throw new Error('CSV file is empty or has no data rows');
                }

                const headers = lines[0].split(',').map(h => h.trim());
                testData = [];

                for (let i = 1; i < lines.length; i++) {
                    const values = parseCSVLine(lines[i]);
                    if (values.length === headers.length && values.some(v => v.trim() !== '')) {
                        const row = {};
                        headers.forEach((header, index) => {
                            row[header] = values[index];
                        });
                        testData.push(row);
                    }
                }

                if (testData.length === 0) {
                    throw new Error('No test data found in CSV');
                }

                document.getElementById('loading').style.display = 'none';
                displayStats();
                displayTests();
            } catch (error) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('emptyState').style.display = 'block';
                document.getElementById('emptyState').innerHTML = `
                    <p>‚ö†Ô∏è ${error.message}</p>
                    <p style="font-size: 14px; color: #666; margin-top: 10px;">
                        Make sure <code>${CSV_FILE}</code> exists and contains test results.
                    </p>
                `;
                console.error('Parse error:', error);
            }
        }

        function parseCSVLine(line) {
            const values = [];
            let current = '';
            let inQuotes = false;

            for (let i = 0; i < line.length; i++) {
                const char = line[i];
                if (char === '"') {
                    inQuotes = !inQuotes;
                } else if (char === ',' && !inQuotes) {
                    values.push(current.trim());
                    current = '';
                } else {
                    current += char;
                }
            }
            values.push(current.trim());
            return values;
        }

        function displayStats() {
            const total = testData.length;
            const passed = testData.filter(t => t.pass === 'True' || t.pass === 'true').length;
            const failed = total - passed;
            const accuracy = total > 0 ? ((passed / total) * 100).toFixed(1) : 0;

            const confidences = testData
                .map(t => parseFloat(t.confidence) || 0)
                .filter(c => c > 0);
            const avgConfidence = confidences.length > 0
                ? (confidences.reduce((a, b) => a + b, 0) / confidences.length * 100).toFixed(1)
                : 0;

            document.getElementById('totalTests').textContent = total;
            document.getElementById('passedTests').textContent = passed;
            document.getElementById('failedTests').textContent = failed;
            document.getElementById('accuracy').textContent = accuracy + '%';
            document.getElementById('avgConfidence').textContent = avgConfidence + '%';

            document.getElementById('statsContainer').style.display = 'grid';
        }

        function displayTests() {
            const grid = document.getElementById('testGrid');
            grid.innerHTML = '';

            testData.forEach((test, index) => {
                const card = document.createElement('div');
                const isPass = test.pass === 'True' || test.pass === 'true';
                card.className = `test-card ${isPass ? 'pass' : 'fail'}`;

                const confidence = parseFloat(test.confidence) || 0;
                const confidencePercent = (confidence * 100).toFixed(1);

                // Format image path for display
                const imagePath = test.image_path || 'N/A';
                const imageName = imagePath.split('/').pop() || imagePath.split('\\').pop() || imagePath;
                
                // Build conditions display
                const conditions = [];
                if (test.severity && test.severity !== 'N/A') conditions.push(`Severity: ${test.severity}`);
                if (test.area && test.area !== 'N/A') conditions.push(`Area: ${test.area}`);
                if (test.focus) conditions.push(`Focus: ${test.focus}`);
                if (test.image_quality) conditions.push(`Quality: ${test.image_quality}`);
                if (test.lighting) conditions.push(`Lighting: ${test.lighting}`);
                if (test.visibility) conditions.push(`Visibility: ${test.visibility}`);
                if (test.weather_season) conditions.push(`Weather: ${test.weather_season}`);
                
                const conditionsHtml = conditions.length > 0 ? `
                    <div class="detail-item" style="margin-top: 10px; background: ${isPass ? '#f0fdf4' : '#fef2f2'}; border-left: 3px solid ${isPass ? '#10b981' : '#ef4444'};">
                        <div class="detail-label">Test Conditions</div>
                        <div style="font-size: 11px; color: #666; line-height: 1.6;">
                            ${conditions.join(' ‚Ä¢ ')}
                        </div>
                        ${!isPass && (test.image_quality === 'Blur' || test.lighting === 'Dim' || test.lighting === 'Backlight' || test.focus === 'SlightBlur') ? 
                            `<div style="font-size: 10px; color: #dc2626; margin-top: 5px; font-style: italic;">
                                ‚ö†Ô∏è Poor conditions may affect accuracy
                            </div>` : ''}
                    </div>
                ` : '';

                card.innerHTML = `
                    <div class="test-header">
                        <span class="test-id">${test.test_id || `Test ${index + 1}`}</span>
                        <span class="status-badge ${isPass ? 'pass' : 'fail'}">
                            ${isPass ? '‚úì Pass' : '‚úó Fail'}
                        </span>
                    </div>
                    <div class="detail-item" style="margin-bottom: 15px;">
                        <div class="detail-label">Crop & Disease</div>
                        <div class="detail-value" style="font-size: 13px;">
                            <strong>${test.crop || 'N/A'}</strong> - ${test.disease || 'N/A'}
                        </div>
                    </div>
                    <div class="detail-item" style="margin-bottom: 15px;">
                        <div class="detail-label">Image Used</div>
                        <div class="detail-value" style="font-size: 12px; word-break: break-all;">${imageName}</div>
                        <div style="font-size: 10px; color: #999; margin-top: 3px;">${imagePath}</div>
                    </div>
                    <img src="${test.image_path}" alt="Test Image" class="test-image" 
                         onerror="this.src='data:image/svg+xml,%3Csvg xmlns=%22http://www.w3.org/2000/svg%22 width=%22400%22 height=%22200%22%3E%3Crect fill=%22%23e5e7eb%22 width=%22400%22 height=%22200%22/%3E%3Ctext x=%2250%25%22 y=%2250%25%22 text-anchor=%22middle%22 dy=%22.3em%22 fill=%22%23999%22%3EImage not found%3C/text%3E%3C/svg%3E';">
                    <div class="test-details">
                        <div class="detail-item">
                            <div class="detail-label">Expected Label</div>
                            <div class="detail-value expected">${test.expected_label || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Predicted Label</div>
                            <div class="detail-value predicted">${test.predicted_label || 'N/A'}</div>
                        </div>
                    </div>
                    <div class="detail-item">
                        <div class="detail-label">Confidence Score</div>
                        <div class="detail-value">${confidencePercent}%</div>
                        <div class="confidence-bar">
                            <div class="confidence-fill" style="width: ${confidencePercent}%"></div>
                        </div>
                    </div>
                    ${conditionsHtml}
                    <div class="test-details" style="margin-top: 10px;">
                        <div class="detail-item">
                            <div class="detail-label">Test ID</div>
                            <div class="detail-value" style="font-size: 12px;">${test.test_id || 'N/A'}</div>
                        </div>
                        <div class="detail-item">
                            <div class="detail-label">Result</div>
                            <div class="detail-value" style="color: ${isPass ? '#10b981' : '#ef4444'};">
                                ${isPass ? '‚úì PASSED' : '‚úó FAILED'}
                            </div>
                        </div>
                    </div>
                    ${test.timestamp ? `<div style="font-size: 11px; color: #999; margin-top: 10px; text-align: center;">Tested: ${new Date(test.timestamp).toLocaleString()}</div>` : ''}
                `;

                grid.appendChild(card);
            });

            document.getElementById('testResults').style.display = 'block';
        }
    </script>
</body>
</html>

